# 小车控制程序使用说明

## 1. 概述

本项目是一套基于ROS2框架的智能小车控制系统。通过分析您的启动脚本和代码，系统集成了自主巡线、二维码识别、以及基于YOLOv5模型的目标检测与避障等高级功能。

项目已经为您配置了一系列快捷启动别名，方便您在终端中快速调用不同功能。

## 2. 环境初始化

在运行任何程序之前，请确保ROS2环境已正确加载。通常，新打开的终端会自动加载位于 `~/.bashrc` 中的配置。如果命令无效，您可以手动执行以下命令来加载环境：

```bash
source ~/.bashrc
```

## 3. 核心功能与快捷命令

您的 `~/.bashrc` 文件中定义了许多别名（alias），作为启动各项功能的快捷方式。

| 别名 | 对应命令 | 功能描述 |
| :--- | :--- | :--- |
| `r1` | `ros2 launch origincar_bringup camera.launch.py` | **启动摄像头**：发布摄像头图像数据流。 |
| `r3` | `ros2 launch origincar_base origincar_bringup.launch.py` | **启动底盘**：启动小车的底层移动控制器，让小车可以运动。 |
| `r4` | `ros2 launch rosbridge_server rosbridge_websocket_launch.xml` | **启动WebSocket**：用于与Web界面或小程序进行通信。 |
| `rf` | `python3 .../line_follower_qrcode_nn.py` | **运行巡线&二维码识别**：核心应用之一，使用神经网络进行巡线并识别二维码。 |
| `rc` | `python3 .../controller/controller.py` | **运行运动控制器**：根据AI节点的输出（如巡线、避障）来控制小车的具体行为。 |
| `run_ai`| `ros2 launch dnn_node_example ...` | **运行AI目标检测**：加载YOLOv5模型进行目标检测，用于实现**自动避障**。 |
| `r2` | `python3 .../line_follower/compress.py` | **运行图像压缩**：一个辅助节点，用于压缩图像，减少网络传输负载。 |
| `rb` | `python3 .../line_follower/baoli.py` | **运行`baoli`脚本**：一个特殊功能脚本，具体作用需分析源码。 |

---

## 4. 使用方法

为了让小车运行特定功能，您需要组合启动多个节点。建议每一个命令都在一个新的终端窗口中执行。

### 场景一：执行AI目标检测与避障

1.  **启动底盘** (如果小车需要移动):
    ```bash
    r3
    ```
2.  **启动摄像头**:
    ```bash
    r1
    ```
3.  **启动AI目标检测节点**:
    ```bash
    run_ai
    ```
4.  **启动总控制器** (接收AI结果并控制小车):
    ```bash
    rc
    ```

### 场景二：执行巡线与二维码识别

1.  **启动底盘**:
    ```bash
    r3
    ```
2.  **启动摄像头**:
    ```bash
    r1
    ```
3.  **启动巡线与二维码识别节点**:
    ```bash
    rf
    ```
4.  **启动总控制器**:
    ```bash
    rc
    ```

---

## 5. 项目文件结构解析

您的代码主要存放在 `/root/dev_ws/src/` 目录下，这是一个ROS2的工作空间。

-   **`dev_ws/src/`**: 存放所有ROS2功能包的源代码。
    -   **`origincar/`**: 小车平台的基础功能包，包括硬件驱动、机器人模型文件(URDF)、基础启动文件等。
    -   **`controller/`**: 运动控制包。其中的 `controller.py` 是核心控制脚本，它订阅来自其他AI节点（如巡线、避障）的数据，并转化为对底盘的控制命令。
    -   **`line_follower/`**: 项目的核心应用功能包。
        -   `line_follower_qrcode_nn.py`: 实现神经网络巡线和二维码识别。
        -   `baoli.py`: 一个特殊功能脚本。
        -   `compress.py`: 图像压缩脚本。
        -   `yolov5_*.py/cpp/pyx`: YOLOv5模型的后处理逻辑，为了性能使用C++和Cython进行了优化。
        -   `*.bin`: 存储了已训练好的神经网络模型文件。
    -   **`line_follower_model/`**: 可能包含用于训练模型或处理数据集的脚本。

-   **`config/`**: 存放模型的配置文件，例如 `yolov5.config` 就是被 `run_ai` 命令所加载的。

-   **`*.bin` 文件 (在根目录)**: 这些都是训练好的模型文件，被不同的Python脚本在运行时加载。

希望这份文档能帮助您更好地理解和使用这个项目！ 

---

## 6. 详细文件及文件夹功能解析

为了让您更深入地理解项目，以下是对主要文件夹及其内部关键文件作用的详细解析。

### 顶层目录 (`/root/`)

-   **`dev_ws/`**:
    这是您的 **ROS2 工作空间 (Workspace)**，所有自定义的机器人功能代码都存放在这里。是开发的核心区域。

-   **`config/`**:
    存放各种**配置文件**。例如，`run_ai` 命令所使用的 `yolov5.config` 就定义了YOLOv5模型的路径、输入尺寸等参数。

-   **`INSTRUCTIONS.md`**:
    (本文件) 项目的说明文档。

-   **`*.bin` 和 `*.onnx` 文件**:
    这些是已经训练好的**神经网络模型文件**。`.bin` 文件是专为端侧推理引擎（如嵌入式开发板的BPU）优化的格式，而 `.onnx` 是一种通用的深度学习模型格式。它们在运行时被 `rf` 或 `run_ai` 等程序加载。

-   **`.ros/`**:
    ROS2的**默认日志和缓存目录**。当节点运行、出现错误或崩溃时，相关的日志信息都会保存在此处的 `log/` 子目录中，是调试问题的重要工具。

### ROS2 工作空间 (`/root/dev_ws/`)

-   **`src/`**:
    **源代码目录 (Source)**。所有ROS2功能包（Package）的源码都在这里，是您进行代码修改和开发的主要位置。

-   **`build/`**:
    **编译目录**。当您运行 `colcon build` 命令时，编译器会在此处生成临时的中间文件。您通常不需要关心此目录。

-   **`install/`**:
    **安装目录**。`colcon build` 成功后，最终的可执行文件、库、启动脚本等都会被安装到这里。`source install/setup.bash` 命令的作用就是将这个目录下的功能包路径添加到您的环境中，这样ROS2才能找到并运行它们。

-   **`log/`**:
    **构建日志目录**。记录了 `colcon build` 过程的日志信息。

### 源代码目录 (`/root/dev_ws/src/`)

这里是项目的灵魂所在，包含了实现所有功能的独立功能包。

-   #### `origincar/`
    -   **作用**: 小车硬件的**基础驱动包**。它很可能包含了与机器人底层硬件（如电机、IMU传感器）通信的代码、机器人的物理描述文件（URDF），以及启动这些基础节点的Launch文件。`r3` 命令启动的就是这个包里的功能。

-   #### `controller/`
    -   **作用**: **高级运动控制包**，是小车的"大脑"。
    -   **`controller/controller.py`**: 这是总控制器节点。它的工作模式通常是：
        1.  **订阅** 来自AI节点（如 `line_follower` 或 `dnn_node_example`）发布的话题（Topic），例如巡线得到的期望角度、或者避障发现的障碍物位置。
        2.  根据这些输入信息，**决策**出小车下一步应该如何运动（前进、后退、左转、右转）。
        3.  **发布** 一个标准的 `geometry_msgs/msg/Twist` 类型的消息到 `/cmd_vel` 话题，由底盘节点（`origincar`）接收并驱动电机实际执行。

-   #### `line_follower/`
    -   **作用**: **核心AI应用功能包**，实现了大部分高级功能。
    -   **`line_follower/line_follower_qrcode_nn.py`**: **巡线与二维码识别节点**。它接收摄像头图像，调用 `.bin` 模型进行推理，计算出车道线的中心位置和偏移量，并发布结果供 `controller` 节点使用。同时，它还集成了二维码检测与识别逻辑。
    -   **`line_follower/baoli.py`**: "baoli"（暴力）可能是一种**备用或更激进的控制策略**的脚本，例如在特定模式下（如冲刺）使用。
    -   **`line_follower/compress.py`**: **图像压缩节点**。订阅原始图像话题，并发布一个压缩后的话题。这对于通过WiFi进行远程监控（例如在网页上查看摄像头画面）非常有用，可以大大降低延迟。
    -   **`line_follower/yolov5_*.{py,cpp,pyx,so}`**: **YOLOv5后处理模块**。为了达到实时处理的性能要求，这部分代码使用C++和Cython进行了优化。它的作用是解析YOLOv5神经网络输出的原始张量（Tensor），进行非极大值抑制（NMS）等操作，最终得到清晰的目标边界框（Bounding Box），然后发布出去用于避障。
    -   **`line_follower/setup.py`**: **C++扩展编译配置**。这个文件配置了如何将 `.pyx` 和 `.cpp` 文件编译成Python可以调用的 `.so` 动态链接库，是性能优化的关键。

-   #### `line_follower_model/`
    -   **作用**: **模型与数据处理工具包**。从命名和历史命令来看，这个包可能包含用于模型训练的辅助脚本，例如：
        -   图像标注工具。
        -   数据增强脚本。
        -   将训练好的模型（如 `.pt` 或 `.h5` 格式）转换为板端可用的 `.bin` 格式的脚本。 